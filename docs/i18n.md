# Internationalization (i18n)

## Overview

Send provides first-class multilingual support across Expo (native) and Next.js (web) surfaces. The i18n system is fully implemented with:

- **5 supported languages**: English (`en`), Spanish (`es`), Chinese (`zh`), German (`de`), French (`fr`)
- **24 feature-based namespaces** for organized translations
- **Automated translation generation** via OpenRouter API
- **Platform-specific locale persistence** for web and native
- **RTL language support** foundation (Arabic, Farsi, Hebrew, Kurdish, Urdu)

## Design Principles

- Predictable language detection, switching, and persistence that respects user preferences
- Tooling and guardrails so developers can add, translate, and validate copy safely
- Well-isolated providers and utilities that preserve existing stability

## Technical Stack

- **Core library:** `i18next` (v23.11.5)
- **React bindings:** `react-i18next` (v15.4.0)
- **Expo locale signals:** `expo-localization` (~17.0.7)
- **Persistence:** `@react-native-async-storage/async-storage` on native, `window.localStorage` on web
- **Formatting helpers:** Built-in `Intl` APIs with light wrappers for currency, dates, and relative time

## Architecture

### Resource Organization

Translation files are located in `packages/app/i18n/resources/` with the following structure:

```
packages/app/i18n/
├── config.ts          # i18n initialization and configuration
├── locales.ts         # Locale utilities and display names
├── index.ts           # Public exports
└── resources/
    ├── account/
    ├── activity/
    ├── affiliate/
    ├── canton-wallet/
    ├── common/
    ├── deposit/
    ├── earn/
    ├── explore/
    ├── home/
    ├── invest/
    ├── leaderboard/
    ├── maintenance/
    ├── navigation/
    ├── onboarding/
    ├── paymaster-allowance/
    ├── rewards/
    ├── secret-shop/
    ├── send/
    ├── sendpot/
    ├── send-token-upgrade/
    ├── settings/
    ├── splash/
    ├── trade/
    └── unknown/
```

Each namespace contains JSON files for each locale (e.g., `en.json`, `es.json`, `zh.json`, `de.json`).

English (`en`) is the canonical source. Missing keys fall back to English at runtime.

### Initialization & Provider Integration

**Expo/React Native** (`apps/expo/app/_layout.tsx`):
- Initializes i18n client on app boot
- Resolves initial language asynchronously before revealing main UI
- Uses gated render to avoid flicker

**Next.js** (`apps/next/pages/_app.tsx`):
- Initializes with English immediately to avoid async detection race
- Updates to user's preferred locale after hydration

**Provider Tree** (`packages/app/provider/index.tsx`):
- Wraps application with `<I18nextProvider i18n={i18nInstance}>`
- Positioned before Auth and other critical providers

### Language Detection & Persistence

**Detection order:**
1. Explicit user setting (from storage)
2. Default to English for new users (auto-detection disabled)

**Storage abstraction** (`packages/app/utils/i18n/localeStorage*.ts`):
- Web: `window.localStorage` with key `'i18n.locale'`
- Native: `@react-native-async-storage/async-storage` with same key
- Graceful error handling for private mode and storage quota errors

**Key functions:**
- `getStoredLocale()` – Retrieve user's chosen locale
- `setStoredLocale(locale)` – Save user's chosen locale
- `resolvePreferredLocale()` – Determine active locale
- `changeLanguage(locale)` – Switch language and persist

## Developer Guide

### Using Translations in Components

```tsx
import { useTranslation } from 'react-i18next'

function MyComponent() {
  const { t } = useTranslation('namespace')
  return <Text>{t('key.path')}</Text>
}
```

### Adding New Translation Keys

1. Add keys to the English JSON file in `packages/app/i18n/resources/<namespace>/en.json`
2. Reference them in code via `t('key')` or `<Trans>` components for rich text
3. Generate translations for other locales:

```bash
yarn i18n:translate --locale es
yarn i18n:translate --locale zh
yarn i18n:translate --locale de
```

### Translation Commands

| Command | Description |
|---------|-------------|
| `yarn i18n:translate --locale <code>` | Generate translations for a locale |
| `yarn i18n:translate --locale <code> --dry-run` | Preview without making changes |
| `yarn i18n:translate --locale <code> --force` | Retranslate all keys (not just missing) |
| `yarn i18n:translate --locale <code> --namespace <name>` | Translate specific namespace(s) |
| `yarn i18n:sync` | Validate JSON structure across locales |
| `yarn i18n:check` | CI validation (same as sync with exit code) |

**Requirements:** `OPENROUTER_API_KEY` environment variable must be set for translation generation.

### Adding a New Language

1. Add the locale code to `SUPPORTED_LOCALES` in `packages/app/i18n/locales.ts`
2. Add the display name to `FALLBACK_LABELS` in the same file
3. Generate translations: `yarn i18n:translate --locale <code>`

### Translation Script Features

- Uses OpenRouter API with `google/gemini-2.0-flash-001` model by default
- Preserves placeholders (`{{variables}}`, `{value}`, `%s` patterns)
- Only translates missing keys by default (use `--force` to retranslate all)
- Automatic retry with exponential backoff
- JSON normalization and sorting for consistency
- Backup creation with `--backup` flag

## Supported Languages

| Code | Language | Status |
|------|----------|--------|
| `en` | English | Canonical source |
| `es` | Español (Spanish) | Complete |
| `zh` | 中文 (Chinese) | Complete |
| `de` | Deutsch (German) | Complete |
| `fr` | Français (French) | Complete |

## Future Considerations

- **RTL layout support:** Foundation exists for Arabic, Farsi, Hebrew, Kurdish, and Urdu
- **Backend localization:** Notifications, emails, and Supabase edge functions if required
- **Additional languages:** Add via the translation script as needed
